<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terrain Occupancy Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .test-case {
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .test-case h3 {
            margin-top: 0;
        }
        .pass {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        .fail {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Terrain Occupancy Detection Tests</h1>
    <div id="results"></div>

    <script type="module">
        // Simple test cases for occupancy detection
        import { getTerrainOccupancy, pointInShape } from './src/lib/utils/collision/occupancy.ts';

        const results = document.getElementById('results');

        function test(name, fn) {
            try {
                const result = fn();
                const div = document.createElement('div');
                div.className = `test-case ${result ? 'pass' : 'fail'}`;
                div.innerHTML = `<h3>${result ? '✓' : '✗'} ${name}</h3>`;
                results.appendChild(div);
                return result;
            } catch (error) {
                const div = document.createElement('div');
                div.className = 'test-case fail';
                div.innerHTML = `<h3>✗ ${name}</h3><pre>${error.message}\n${error.stack}</pre>`;
                results.appendChild(div);
                return false;
            }
        }

        // Test 1: Point inside simple rectangle
        test('Point inside rectangle at origin', () => {
            const piece = {
                id: 'test-1',
                shapes: [{ type: 'rectangle', width: 10, height: 5 }],
                position: { x: 0, y: 0 },
                blocking: true
            };
            const point = { x: 5, y: 2.5 }; // Center of rectangle
            return pointInShape(point, piece.shapes[0], piece);
        });

        // Test 2: Point outside simple rectangle
        test('Point outside rectangle', () => {
            const piece = {
                id: 'test-2',
                shapes: [{ type: 'rectangle', width: 10, height: 5 }],
                position: { x: 0, y: 0 },
                blocking: true
            };
            const point = { x: 15, y: 2.5 }; // Outside rectangle
            return !pointInShape(point, piece.shapes[0], piece);
        });

        // Test 3: Point inside rotated rectangle
        test('Point inside 45° rotated rectangle', () => {
            const piece = {
                id: 'test-3',
                shapes: [{ type: 'rectangle', width: 10, height: 5 }],
                position: { x: 23, y: 10 },
                rotation: 45,
                blocking: true
            };
            const point = { x: 25, y: 12 }; // Should be inside
            return pointInShape(point, piece.shapes[0], piece);
        });

        // Test 4: getTerrainOccupancy with single piece
        test('getTerrainOccupancy - point on terrain', () => {
            const pieces = [{
                id: 'piece-1',
                shapes: [{ type: 'rectangle', width: 12, height: 6 }],
                position: { x: 24, y: 19 },
                blocking: true
            }];
            const point = { x: 30, y: 22 }; // Center of piece
            const occupied = getTerrainOccupancy(point, pieces);
            return occupied.length === 1 && occupied[0] === 'piece-1';
        });

        // Test 5: getTerrainOccupancy - point not on terrain
        test('getTerrainOccupancy - point off terrain', () => {
            const pieces = [{
                id: 'piece-1',
                shapes: [{ type: 'rectangle', width: 12, height: 6 }],
                position: { x: 24, y: 19 },
                blocking: true
            }];
            const point = { x: 10, y: 10 }; // Far away
            const occupied = getTerrainOccupancy(point, pieces);
            return occupied.length === 0;
        });

        // Test 6: Skip line shapes as footprints
        test('getTerrainOccupancy - skip line shapes', () => {
            const pieces = [{
                id: 'piece-1',
                shapes: [
                    { type: 'line', start: { x: 0, y: 0 }, end: { x: 10, y: 0 }, thickness: 1 }
                ],
                position: { x: 0, y: 0 },
                blocking: true
            }];
            const point = { x: 5, y: 0 }; // On the line
            const occupied = getTerrainOccupancy(point, pieces);
            return occupied.length === 0; // Lines can't be footprints
        });

        // Test 7: Non-blocking terrain ignored
        test('getTerrainOccupancy - skip non-blocking terrain', () => {
            const pieces = [{
                id: 'piece-1',
                shapes: [{ type: 'rectangle', width: 10, height: 5 }],
                position: { x: 0, y: 0 },
                blocking: false // Non-blocking
            }];
            const point = { x: 5, y: 2.5 }; // Center
            const occupied = getTerrainOccupancy(point, pieces);
            return occupied.length === 0; // Non-blocking terrain ignored
        });

        // Summary
        setTimeout(() => {
            const testCases = document.querySelectorAll('.test-case');
            const passed = document.querySelectorAll('.test-case.pass').length;
            const failed = document.querySelectorAll('.test-case.fail').length;

            const summary = document.createElement('div');
            summary.style.marginTop = '30px';
            summary.style.padding = '20px';
            summary.style.background = failed === 0 ? '#d4edda' : '#f8d7da';
            summary.style.borderRadius = '5px';
            summary.innerHTML = `<h2>Summary: ${passed}/${testCases.length} tests passed</h2>`;
            results.appendChild(summary);
        }, 100);
    </script>
</body>
</html>
